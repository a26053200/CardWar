---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by zheng.
--- DateTime: 2019/5/29 23:15
---

---@class Game.Core.Utils.AStarTools
local AStarTools = {}


---@param grid AStar.Grid
---@param center UnityEngine.Vector3
---@return UnityEngine.Rect
function AStarTools.GetAreaNodeRect(grid, center, w, h)
    local node = grid:NodeFromWorldPoint(center) ---@type AStar.Node
    local rect = Rect.New(node.gridX, node.gridY, w, h)
    return rect
end

--获取一定距离周围点
---@param grid AStar.Grid
---@param center AStar.Node
---@return table<number, AroundNode>
function AStarTools.GetAroundNodes(grid, center, d)
    local nodes = {}
    for y = -d, d do
        for x = -d, d do
            if x ~= 0 or y ~= 0 then
                local gx = center.gridX + x
                local gy = center.gridY + y
                if AStarTools.isWalkable_xy(gx, y) then
                    table.insert(nodes, {node = grid:GetNode(gx, gy), ownerId = 0})
                end
            end
        end
    end
    return nodes
end

--获取一定距离周围点
---@param src Game.Modules.Battle.Items.Avatar
---@param nodes table<number, AroundNode>
---@return AroundNode
function AStarTools.GetNearestNode(src, nodes)
    local min = Mathf.Infinity
    local node
    for i = 1, #nodes do
        if nodes[i].ownerId == src.avatarInfo.id then
            return nodes[i]
        end
    end
    for i = 1, #nodes do
        local d = AStarTools.DistanceNode(src.node,nodes[i].node)
        if d < min and nodes[i].ownerId == 0 then
            min = d
            node = nodes[i]
        end
    end
    if node == nil then
        for i = 1, #nodes do
            local d = AStarTools.DistanceNode(src.node,nodes[i].node)
            if d < min then
                min = d
                node = nodes[i]
            end
        end
    end
    return node
end

--矩形区域随机世界坐标数组
---@param rect UnityEngine.Rect
function AStarTools.GetRectRandomPos(start, rect, r)
    local points = {}
    local idx = 1
    local randoms = Tools.GetRandomArray(rect.width * rect.height)
    local L = r * 2
    for i = 1, rect.height do
        for j = 1, rect.width do
            local pt = start + Vector3.New(r + (j - 1) * L, 0, r + (i - 1) * L)
            points[randoms[idx]] = pt
            idx = idx + 1
        end
    end
    return points
end

--格子是否相等
---@param node1 AStar.Node
---@param node2 AStar.Node
function AStarTools.isEqualNode(node1, node2)
    return node1.gridX == node2.gridX and node1.gridY == node2.gridY
end

--在限定范围内随机上下左右方向点
---@param grid AStar.Grid
---@param src AStar.Node
---@return AStar.Node
function AStarTools.GetRandomNeighboursNode(grid, src)
    local rx = math.random(-1,1)
    local ry = math.random(-1,1)
    if rx == 0 and ry == 0 then
        return nil
    end
    if src.gridX + rx >= 0 and src.gridX + rx < grid.gridSizeX
            and src.gridY + ry >= 0 and src.gridY + ry < grid.gridSizeY then
        local node = grid:GetNode(src.gridX + rx, src.gridY + ry)
        if node.walkable then
            return node
        end
    end
    return nil
end

--格子节点是否walkable
function AStarTools.isWalkable(node)
    return AStarTools.isWalkable_xy(node.gridX, node.gridY)
end

--格子是否相等
---@param x number
---@param y number
function AStarTools.isWalkable_xy(x, y)
    if x >= 0 and y < World.grid.gridSizeX and y >= 0 and y < World.grid.gridSizeY then
        local node = World.grid:GetNode(x, y)
        if node.walkable then
            return node
        end
    end
end

--在限定范围内随机上下左右方向点
---@param limitRect UnityEngine.Rect
---@param src AStar.Node
---@return AStar.Node
function AStarTools.GetRandomLimitedNode(limitRect, src)
    local rx = math.random(-1,1)
    local ry = math.random(-1,1)
    if rx == 0 and ry == 0 then
        return nil
    end
    rx = src.gridX + rx
    ry = src.gridY + ry
    if limitRect:Contains(Vector2.New(rx,ry)) then
        return World.grid:GetNode(rx, ry)
    end
    return nil
end

--在限定范围内随机上下左右方向点
---@param rect UnityEngine.Rect
---@param src AStar.Node
---@return AStar.Node
function AStarTools.GetRectNearestNode(rect, src)
    local minDistance = Mathf.Infinity
    local node = nil;
    for i = 1, rect.height do
        for j = 1, rect.width do
            local distance = AStarTools.Distance(src, rect.x + (j - 1), rect.y + (i - 1))
            if distance < minDistance then
                minDistance = distance
                node = World.grid:GetNode(rect.x + (j - 1), rect.y + (i - 1))
            end
        end
    end
    return node
end

---@param node1 AStar.Node
---@param node2 AStar.Node
function AStarTools.DistanceNode(node1, node2)
    return Mathf.Max(Mathf.Abs(node1.gridX - node2.gridX), Mathf.Abs(node1.gridY - node2.gridY))
end

---@param src AStar.Node
function AStarTools.Distance(src, x, y)
    return Vector2.Distance(Vector2.New(src.gridX, src.gridY), Vector2.New(x, y))
end

return AStarTools
    

    