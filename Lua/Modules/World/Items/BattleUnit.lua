---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by zheng.
--- DateTime: 2020/4/12 19:44
--- 战斗单位
---

local BattleUnitHUD = require("Game.Modules.Battle.Components.BattleUnitHUD")
local FloatNumber = require("Game.Modules.Battle.Components.FloatNumber")
local PerformancePlayer = require("Game.Modules.Battle.Performances.PerformancePlayer")
local AccountCtrl = require("Game.Modules.Battle.Components.AccountCtrl")
local GridBehaviorStrategy = require("Game.Modules.Battle.Behaviors.Strategy.GridBehaviorStrategy")
local BattleItemEvents = require("Game.Modules.Battle.Events.BattleItemEvents")
local AvatarGridBehavior = require("Game.Modules.Battle.Behaviors.AvatarGridBehavior")
local BattleUnitBehavior = require("Game.Modules.Battle.Behaviors.BattleUnitBehavior")
local Avatar = require("Game.Modules.World.Items.Avatar")

---@class Game.Modules.World.Items.BattleUnit : Game.Modules.World.Items.Avatar
---@field New fun(battleUnitVo:Game.Modules.Battle.Vo.BattleUnitVo, context:WorldContext) : Module.World.Items.Monster
---@field battleUnitVo Game.Modules.Battle.Vo.BattleUnitVo
---@field behavior Game.Modules.Battle.Behaviors.BattleUnitBehavior
---@field strategy Game.Modules.Battle.Behaviors.Strategy.BehaviorStrategyBase -- 策略
---@field accountCtrl Game.Modules.Battle.Components.AccountCtrl
---@field performancePlayer Game.Modules.Battle.Performances.PerformancePlayer
---@field ownerCardVo Game.Modules.Card.Vo.CardVo 英雄所属卡
---@field layoutIndex number 布局索引 默认0 表示没有上场
---@field layoutGrid Game.Modules.Battle.Layouts.LayoutGrid 所在布局格子
---@field floatNum Game.Modules.Battle.Components.FloatNumber
local BattleUnit = class("Game.Modules.World.Items.BattleUnit", Avatar)

---@param battleUnitVo Game.Modules.Battle.Vo.BattleUnitVo
---@param context WorldContext
function BattleUnit:Ctor(battleUnitVo, context)
    self:SetContext(context)
    self.battleUnitVo = battleUnitVo
    BattleUnit.super.Ctor(self, battleUnitVo)
end

--重置属性
function BattleUnit:ResetAttr()
    self.battleUnitVo:Reset()
end

function BattleUnit:LoadObject()
    if self.avatarInfo.prefabUrl then
        self.renderObj = self.context.pool:CreateObjectByPool(self.avatarInfo.prefabUrl)
        self.renderObj.transform:SetParent(self.transform)
        self.renderObj:ResetTransform()
        self:OnRenderObjInit()
    end
end

function BattleUnit:OnRenderObjInit()
    BattleUnit.super.OnRenderObjInit(self)
    self:SetLayer(Layers.Name.BattleItem)

    self.debugName = self.battleUnitVo:GetDebugName()

    self.accountCtrl = AccountCtrl.New(self)
    self.performancePlayer = PerformancePlayer.New(self)
    self.strategy = GridBehaviorStrategy.New(self)
    self.behavior = BattleUnitBehavior.New(self)

    self.hud = BattleUnitHUD.New(self)
end

function BattleUnit:SetHudVisible(visible)
    if self.hud then
        self.hud.gameObject:SetActive(visible)
    end
end

--出生效果
function BattleUnit:Born(callback)
    LuaReflectHelper.PushVo(self, self.battleUnitVo)
    self.luaReflect:PushLuaFunction("JsonToLua", handler(self,self.JsonToLua))
    self:PlayBorn(function()
        if callback then callback() end
        self:PlayIdle()
        self:OnBorn()
    end)
    self:SetRenderEnabled(true)
end

function BattleUnit:JsonToLua(key, json)
    LuaReflectHelper.JsonToLua(self, key, json)
end

function BattleUnit:OnBorn(callback)
    BattleItemEvents.DispatchItemEvent(BattleItemEvents.BattleItemBorn, self)
    if callback then
        callback()
    end
end

function BattleUnit:SetRenderEnabled(enabled)
    self.renderObj:SetActive(enabled)
    --if not enabled then
    --    logError("SetRenderEnabled")
    --end
    if self.shadow then
        self.shadow:SetActive(enabled)
    end
end

function BattleUnit:SetBehaviorEnabled(enabled)
    if not self.behavior then
        self.behavior = BattleUnitBehavior.New(self)
    end
    if enabled then
        if self:IsDead() then
            --logError("This item is dead, can not set behavior enabled")
            return
        end
        --self.isMoving = true
        --self:UpdateAroundPos()
        --logError("SetBehaviorEnabled true")
        self.behavior:Play()
    else
        self.behavior:Stop()
    end
end

--伤害结算
---@param accountNode Game.Modules.Battle.Report.Nodes.AccountNode
function BattleUnit:AccountHurt(accountNode, isHelpful)
    if isHelpful then
        self.battleUnitVo.curHp = math.min( self.battleUnitVo.curHp + accountNode.dam,  self.battleUnit.battleUnitVo.maxHp)
        self:DoHurt(accountNode)
    else
        local tpRecover = self.battleUnitVo:DamageRecoveryTP(accountNode.dam)
        self.battleUnitVo:RecoveryTP(tpRecover)--恢复Tp
        self.battleUnitVo.curHp = math.max(0, self.battleUnitVo.curHp - accountNode.dam)
        self:DoHurt(accountNode)
        self:PlayIdle()
        self:PlayHit()
        self:_debug(string.format("<color=#FFFFFFFF>Skill:%s</color> <color=#FFFF00FF>%s/%s %s</color> (%2f)",
                accountNode.skillId,
                self.battleUnitVo.curHp,
                self.battleUnitVo.maxHp,
                accountNode.dam,
                (self.battleUnitVo.curHp / self.battleUnitVo.maxHp) * 100))
        --target.soundGroup:Play(skillInfo.hitSound)
    end
    --self:HurtPerformance(target, skillInfo, account)
end

---@param hurtInfo HurtInfo
function BattleUnit:DoHurt(hurtInfo)
    FloatNumber.Create(self, hurtInfo)
end

function BattleUnit:OnDeadOver()
    self.deadOver = true
    self:Dispose()
end

function BattleUnit:OnDead()
    BattleUnit.super.OnDead(self)

    self:Clean()

    --self:_debug("BattleItem:OnDead " .. self.gameObject.name )
    local event = {}
    event.type = BattleItemEvents.BattleItemDead
    event.target = self
    BattleItemEvents.Dispatch(event)
    if self.layoutGrid then
        self.layoutGrid:ClearOwner()
        self.layoutGrid = nil
    end

    self:PlayDead(Handler.New(self.OnDeadOver, self))
end

--回收
function BattleUnit:Recovery()
    BattleUnit.super.Recovery(self)
    local pool = self.context.pool:GetObjectPool(self.avatarInfo.prefabUrl)
    --把影子换回去
    if not isnull(self.shadow)  then
        self.shadow.transform:SetParent(self.renderObj.transform)
    end
    pool:Store(self.renderObj)
end

function BattleUnit:Clean()
    if self.behavior then
        self.behavior:Dispose()
        self.behavior = nil
    end
    if self.hud then
        self.hud:Dispose()
        self.hud = nil
    end
    if self.cc then
        self.cc.enabled = false
    end
end

function BattleUnit:Dispose()
    self:Recovery()
    BattleUnit.super.Dispose(self)
    self:Clean()

    if self.animCtrl then
        self.animCtrl:Dispose()
        self.animCtrl = nil
    end
    if self.battleUnitVo then
        self.battleUnitVo:Dispose()
        self.battleUnitVo = nil
    end
    --if self.effectWidget then
    --    self.effectWidget:RemoveSingCircle()
    --end
    --if self.gameObject.transform.childCount > 0 then
    --    logError("You must recovery the renderObj")
    --end
    Destroy(self.gameObject)
end

return BattleUnit