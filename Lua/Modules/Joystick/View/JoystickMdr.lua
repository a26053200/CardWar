---
--- Generated by Tools
--- Created by zheng.
--- DateTime: 2019-09-18-21:46:06
---

local BaseMediator = require("Game.Core.Ioc.BaseMediator")
---@class Game.Modules.Joystick.View.JoystickMdr : Game.Core.Ioc.BaseMediator
---@field lastStickPos UnityEngine.Vector3
local JoystickMdr = class("JoystickMdr",BaseMediator)

local ECSWorld = nil

function JoystickMdr:OnInit()
    self.hotArea = self.gameObject:FindChild("HotArea")
    self.canvasGroup = self.hotArea:GetCanvasGroup("HotArea")
    self.pan = self.gameObject:FindChild("HotArea/Pan")
    self.stick = self.gameObject:FindChild("HotArea/Stick")

    self.hotAreaRect = self.hotArea:GetRect()
    self.panRect = self.pan:GetRect()
    self.stickRect = self.stick:GetRect()

    self.radius = self.panRect.sizeDelta.x / 2

    self.canvasGroup.alpha = 0
    ECSWorld = Game.ECSWorld.Instance
end

function JoystickMdr:RegisterListeners()
    self:AddObjectEventListener(LuaHelper.AddObjectPointerDown, self.hotArea,handler(self, self.OnHotAreaDown))
    self:AddObjectEventListener(LuaHelper.AddObjectBeginDrag,   self.hotArea,handler(self, self.OnHotAreaBeginDrag))
    self:AddObjectEventListener(LuaHelper.AddObjectDrag,        self.hotArea,handler(self, self.OnHotAreaDrag))
    self:AddObjectEventListener(LuaHelper.AddObjectEndDrag,     self.hotArea,handler(self, self.OnHotAreaDragEnd))
    self:AddObjectEventListener(LuaHelper.AddObjectPointerUp,   self.hotArea,handler(self, self.OnHotAreaDragEnd))
end



---@param eventData UnityEngine.EventSystems.PointerEventData
function JoystickMdr:OnHotAreaDown(eventData)
    local position = Tools.ScreenToUICanvasPoint(eventData.position, self.uiCanvas, self.hotAreaRect)
    self.panRect.position = position
    self.stickRect.position = position
    self.lastStickPos = position
    self.canvasGroup:DOPause()
    self.canvasGroup:DOFade(1,0.2)


end

---@param eventData UnityEngine.EventSystems.PointerEventData
function JoystickMdr:OnHotAreaBeginDrag(eventData)
    local position = Tools.ScreenToUICanvasPoint(eventData.position, self.uiCanvas, self.hotAreaRect)
    self.stickRect.position = position
end

---@param eventData UnityEngine.EventSystems.PointerEventData
function JoystickMdr:OnHotAreaDrag(eventData)
    local position = Tools.ScreenToUICanvasPoint(eventData.position, self.uiCanvas, self.hotAreaRect)
    self.stickRect.position = position
    local dir = self.stickRect.anchoredPosition - self.panRect.anchoredPosition;
    local distance = Vector2.Distance(self.stickRect.anchoredPosition, self.panRect.anchoredPosition)
    print("distance " .. distance .. " radius " .. self.radius)
    if distance > self.radius then
        self.stickRect.anchoredPosition = self.panRect.anchoredPosition + dir.normalized * self.radius
    end

    local p1 = self.stickRect.anchoredPosition
    local p0 = self.panRect.anchoredPosition
    ECSWorld.Horizontal = (p1.x - p0.x) / self.radius
    ECSWorld.Vertical = (p1.y - p0.y) / self.radius
end

---@param eventData UnityEngine.EventSystems.PointerEventData
function JoystickMdr:OnHotAreaDragEnd(eventData)
    self.canvasGroup:DOFade(0,0.2)
    self.stick.transform:DOMove(self.lastStickPos,0.2)

    ECSWorld.Horizontal = 0
    ECSWorld.Vertical = 0
end

function JoystickMdr:Update()
    local LC = Input.GetKeyDown(UnityEngine.KeyCode.LeftControl)
    local RC = Input.GetKeyDown(UnityEngine.KeyCode.RightControl)

    --初始武器
    if Input.GetKey(UnityEngine.KeyCode.Space) then
        ECSWorld.ActiveWeaponNo = 0
        ECSWorld.ActiveWeaponLevel = 0
    end

    if Input.GetKey(UnityEngine.KeyCode.F1) then
        ECSWorld.ActiveWeaponNo = 1
        --ECSWorld.ActiveWeaponLevel = 1
    end

    if Input.GetKey(UnityEngine.KeyCode.F2) then
        ECSWorld.ActiveWeaponNo = 2
        --ECSWorld.ActiveWeaponLevel = 1
    end

    if Input.GetKey(UnityEngine.KeyCode.Alpha1) then
        ECSWorld.ActiveWeaponLevel = 1
    end
    if Input.GetKey(UnityEngine.KeyCode.Alpha2) then
        ECSWorld.ActiveWeaponLevel = 2
    end
    if Input.GetKey(UnityEngine.KeyCode.Alpha3) then
        ECSWorld.ActiveWeaponLevel = 3
    end
    if Input.GetKey(UnityEngine.KeyCode.Alpha4) then
        ECSWorld.ActiveWeaponLevel = 4
    end
    if Input.GetKey(UnityEngine.KeyCode.Alpha5) then
        ECSWorld.ActiveWeaponLevel = 5
    end
end

return JoystickMdr
