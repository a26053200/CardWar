---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by zhengnan.
--- DateTime: 2020/4/9 14:38
--- 攻击结算上下文
---

--伤害信息
---@class HurtInfo
---@field atker Game.Modules.World.Items.BattleUnit
---@field defer Game.Modules.World.Items.BattleUnit
---@field isHelpful boolean
---@field dam number     伤害
---@field critDam number 暴击伤害
---@field atk number     攻击
---@field def number     防御
---@field crit number    暴击倍数
---@field miss boolean 是否命中
---@field acc number

local PoolVo = require("Game.Modules.Common.Pools.PoolObject")
---@class Game.Modules.World.Contexts.AccountContext : Game.Modules.Common.Pools.PoolObject
---@field New fun():Game.Modules.World.Contexts.AccountContext
---@field battleUnit Game.Modules.World.Items.BattleUnit 攻击者
---@field targetList table<number, Game.Modules.World.Items.BattleUnit> 目标
---@field accountTargetList table<number, Game.Modules.World.Items.BattleUnit> 已经被结算的目标
---@field account AccountInfo
local AccountContext = class("Game.Modules.World.Contexts.AccountContext", PoolVo)

local Sid = 1

function AccountContext:Ctor()
    self.accountTargetList = List.New()
end

---@param skillVo Game.Modules.Battle.Vo.SkillVo
---@param attacker Game.Modules.World.Items.Avatar
---@param account AccountInfo
function AccountContext:Init(skillVo, attacker, account)
    self.id = Sid
    Sid = Sid + 1
    self.battleUnit = attacker
    self.account = account
    self.skillVo = skillVo
end

--开始
function AccountContext:Start(gridSelect)
    gridSelect = gridSelect or self.account.gridSelect
    local opposeCamp = BattleUtils.GetOpposeCamp(self.battleUnit.avatarVo.camp) --对立阵营
    local targetGridList = GridUtils.GetGrids(gridSelect, opposeCamp, self.battleUnit)
    self.targetList = self.battleUnit.context.battleLayout:GetTargetList(opposeCamp, targetGridList)
end

--过程
function AccountContext:ExecuteAccount()
    for i = 1, #self.targetList do
        self:OnAccount(self.targetList[i])
    end
end

--是否被结算过
function AccountContext:HasAccount(target)
    return self.accountTargetList:Contain(target)
end
--结算
---@param target Game.Modules.World.Items.BattleUnit
function AccountContext:OnAccount(target)
    --target:_debug("target is be account")

    self.accountTargetList:Add(target)
    self:DamageAccount(self.skillVo, self.account, target)
    --检查目标是否死亡
    --self.battleUint.accountWidget:OnCheckDead(self.skillVo,target)
end

--最终伤害结算
---@param target Game.Modules.World.Items.BattleUnit
---@param skillVo Game.Modules.Battle.Vo.SkillVo
---@param account AccountInfo
function AccountContext:DamageAccount(skillVo, account, target)
    --是否增益结算 例如加血  上buff等
    local isHelpful = account.targetMode == TargetMode.Self or account.targetMode == TargetMode.Friend
    local battleUnitVo = self.battleUnit.battleUnitVo
    local avatarAtk = 0
    local minDam = 0
    if account.targetMode == TargetMode.Enemy
            --or account.targetMode == TargetMode.AOE
            or account.targetMode == TargetMode.Pos then
        avatarAtk = battleUnitVo.battleUnitInfo.atk
        minDam = 1
    end
    local hurtInfo = {} ---@type HurtInfo
    hurtInfo.atker = self.battleUnit
    hurtInfo.target = target
    hurtInfo.isHelpful = isHelpful
    hurtInfo.atk = avatarAtk + avatarAtk * (skillVo.skillInfo.damageAdd + account.damageAdd)
    hurtInfo.def = target and target.battleUnitVo.battleUnitInfo.def or 0
    local crit = skillVo.skillInfo.crit + battleUnitVo.battleUnitInfo.crit -- 技能本身的暴击率与自身暴击率相加
    hurtInfo.crit = (math.random() <= crit) and battleUnitVo.battleUnitInfo.critPower or 1 --暴击
    hurtInfo.dam = math.max(minDam, math.floor((hurtInfo.atk - hurtInfo.def) * hurtInfo.crit)) --简单计算:伤害 - 防御
    hurtInfo.acc = math.random() --命中率
    local isMiss = false
    --计算闪避
    --local signet = target.signetMap[self.battleUnit.sid .. "_" .. skillInfo.id]
    --if hurtInfo.acc > self.battleUnit.avatarInfo.acc
    --        or signet == SignetType.Dodge then
    --    isMiss = true
    --end
    --if signet ~= nil then
    --    target.performancePlayer:Play(account.signetPerformance,nil,self.battleUnit, account)
    --end

    if isMiss then
        hurtInfo.miss = true
        --print("miss")
        if target then
            target:DoHurt(hurtInfo)
        end
        return
    end
    hurtInfo.miss = false
    if target then
        if isHelpful then
            target.battleUnitVo.curHp = math.min(target.battleUnitVo.curHp + hurtInfo.dam, target.battleUnitVo.maxHp)
            target:DoHurt(hurtInfo)
        else
            target.battleUnitVo.curHp = math.max(0,target.battleUnitVo.curHp - hurtInfo.dam)
            target:DoHurt(hurtInfo)
            target:PlayIdle()
            target:PlayHit()
            --target.soundGroup:Play(skillInfo.hitSound)
        end
        --self:DisplayHurt(target, skillInfo, account)
    else
        --无目标结算
    end
end

--受击表现
---@param target Game.Modules.World.Items.Avatar
---@param skillInfo SkillInfo
---@param account AccountInfo
function AccountContext:DisplayHurt(target, skillInfo, account)
    target.performancePlayer:Play(account.targetPerformance,nil,self.battleUnit)
    --buff 计算
    if not StringUtil.IsEmpty(account.buffer) then
        target.bufferWidget:Add(account.buffer)
    end
    if not StringUtil.IsEmpty(skillInfo.hitEffect) then
        target.effectWidget:Play(skillInfo.hitEffect, target)
        target.specialEffect:PlaySurround() --播放受击包围效果
    end
end

--结束
function AccountContext:End()
    self:Dispose()
end

function AccountContext:Dispose()
    self.effect = nil
    self.accountTargetList:Clear()
    AccountContextPool:Store(self)
end

return AccountContext