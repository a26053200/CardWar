---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by zhengnan.
--- DateTime: 2020/2/21 10:47
--- 网格区域
---


--刷怪区域数据
---@class GridAreaInfo : AreaBaseInfo
---@field type string 类型 boss , normal
---@field waves table<number,GridWaveInfo>
---@field pos number        区域中心点
---动态数据
---@field index number

local BattleItemEvents = require("Game.Modules.Battle.Events.BattleItemEvents")
local BattleEvent = require("Game.Modules.Battle.Events.BattleEvents")
local GridWave = require("Game.Modules.Battle.Layouts.GridWave")
local AreaBase = require("Game.Modules.Battle.Layouts.AreaBase")

---@class Game.Modules.Battle.Layouts.GridArea : Game.Modules.Battle.Layouts.AreaBase
---@field New fun(areaInfo:GridAreaInfo, checkPointData:CheckPointData):Game.Modules.Battle.Layouts.GridArea
---@field areaInfo GridAreaInfo
---@field checkPointData CheckPointData
---@field waves table<number, Game.Modules.Battle.Layouts.GridWave>
---@field orgBornPoints table<number, UnityEngine.Vector3> --原始出生位置
---@field currWave Game.Modules.Battle.Layouts.GridWave
---@field areaPointObj UnityEngine.GameObject
local GridArea = class("Game.Modules.Battle.Layouts.GridArea", AreaBase)

---@param areaInfo GridAreaInfo
---@param checkPointData CheckPointData
function GridArea:Ctor(areaInfo, checkPointData)
    GridArea.super.Ctor(self)
    self.areaInfo = areaInfo
    self.checkPointData = checkPointData
    self.waves = {}
end

--初始化该区域
function GridArea:InitArea()
    --local totalNum = 0
    for i = 1, #self.areaInfo.waves do
        --local waveInfo = self.areaInfo.waves[i]
        --waveInfo.index = i
        --for j = 1, #waveInfo.wavePoints do
            --local num = math.random(waveInfo.wavePoints[j].minNum, waveInfo.wavePoints[j].maxNum)
            --waveInfo.wavePoints[j].num = num
            --totalNum = totalNum + num
        --end
        local wave = GridWave.New(self.areaInfo.waves[i])
        wave.context = self.context
        self.waves[i] = wave
    end

    self.layoutGrids = self.context.battleLayout.gridLayoutMap[Camp.Def]
end

function GridArea:Refresh()
    if self.isActive then
        return --重复激活
    end
    AddEventListener(BattleItemEvents, BattleItemEvents.BattleItemDead, self.OnMonsterDead, self)
    self:_debug(("GridArea Ready to Refresh AreaId:" .. self.areaInfo.areaIndex))
    self:DoActive()
    --BattleUtils.CreateGrid(self.orgBornPoints, self.forward, self.context)
end

function GridArea:Active()
    if self.isActive then
        return --重复激活
    end
    self.isRefreshOver = false
    self:_debug(("Active AreaId:" .. self.areaInfo.areaIndex))
    self.isActive = true
end

function GridArea:DoActive()
    if self.isActive then
        return --重复激活
    end
    if self.DoActiveCo then
        coroutine.stop(self.DoActiveCo)
    end
    local lastWave = nil ---@type Game.Modules.Battle.Layouts.GridWave
    self.DoActiveCo = coroutine.start(function()
        while not self.isActive do
            coroutine.step(1)
        end
        --等待剧情
        self:OnAreaEnter(Handler.New(function()
            for i = 1, #self.waves do
                local wave = self.waves[i]
                if wave.waveInfo.waveMode == WaveType.Trigger then
                    if wave.waveInfo.delay and wave.waveInfo.delay > 0 then
                        coroutine.wait(wave.waveInfo.delay)
                    end
                elseif wave.waveInfo.waveMode == WaveType.AllDead then --上一波彻底死亡
                    if lastWave then
                        while not lastWave:IsAllDeadOver() do
                            coroutine.step(1)
                        end
                    end
                end

                wave:Refresh(function()
                    self.isBornOver = true
                end)
                while not self.isBornOver do --等到引导结束
                    coroutine.step(1)
                end
                wave:Active()
                self:_debug(string.format("Wave <color=#00FFE2FF>%s</color> Refresh: %s/%s",wave.waveInfo.waveMode,i,#self.waves))
                self.currWave = wave
                lastWave = wave
                if i == 1 then
                    BattleEvent.Dispatch(BattleEvent.BattleStart)
                end
            end
        end , self))
        self:_debug(string.format("Wave Refresh Over"))
        self.isRefreshOver = true
    end)
end


---@param callback Handler
function GridArea:OnAreaEnter(callback)
    if not StringUtil.IsEmpty(self.areaInfo.enterScript) then
        Plot.PlayScript(self.areaInfo.enterScript,callback)
    else
        callback:Execute()
    end
end

---@param callback Handler
function GridArea:OnAreaExit(callback)
    if not StringUtil.IsEmpty(self.areaInfo.exitScript) then
        Plot.PlayScript(self.areaInfo.exitScript,callback)
    else
        callback:Execute()
    end
end

--是否都已经死亡
function GridArea:IsAllDead()
    if not self.isRefreshOver then
        return false
    end
    local monsters = self:GetAllMonster()
    local allDead = true
    for i = 1, monsters:Size() do
        if not monsters[i].deadOver then
            allDead = false
            break;
        end
    end
    return allDead
end

--是否都已经死亡并且死亡动作也播放完毕
---@return boolean
function GridArea:IsAllDeadOver()
    if not self.isRefreshOver then
        return false
    end
    local monsters = self:GetAllMonster()
    local allDead = true
    for i = 1, monsters:Size() do
        if not monsters[i].deadOver then
            allDead = false
            break;
        end
    end
    return allDead
end


--是否都已经死亡并且死亡动作也播放完毕
---@return List | table<number, Game.Modules.World.Items.BattleUnit>
function GridArea:GetAllMonster()
    local monsters = List.New()
    for i = 1, #self.waves do
        local wave = self.waves[i]
        for j = 1, wave.itemList:Size() do
            monsters:Add(wave.itemList[j])
        end
    end
    return monsters
end

---@param event Game.Modules.World.Events.BattleItemEvents
function GridArea:OnMonsterDead(event)
    if event and event.target then
        --local grid = self.context.battleLayout:GetLayoutGridByOwner(event.target)
        --grid:ClearOwner()
    end
end

function GridArea:Clear()
    RemoveEventListener(BattleItemEvents, BattleItemEvents.BattleItemDead, self.OnMonsterDead, self)
end

return GridArea